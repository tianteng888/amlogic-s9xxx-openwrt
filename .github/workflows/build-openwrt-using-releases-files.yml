#=====================================================================================
# 适配s905l3a (aarch64_generic)架构的OpenWrt构建工作流
# 说明：修复参数错误和路径问题，使用动作支持的有效参数
#=====================================================================================

name: Build OpenWrt for s905l3a with fixed kernel

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      openwrt_board:
        description: "设备型号"
        required: true
        default: "s905l3a"
        type: choice
          - s905l3a
          - s905l3a-cm311
          - s905l3a-m401a
      specific_kernel:
        description: "具体内核版本"
        required: true
        default: "6.12.41"
        type: string
      kernel_repo:
        description: "内核仓库"
        required: true
        default: "ophub/kernel"
        type: choice
          - ophub/kernel
      kernel_tag:
        description: "内核标签"
        required: true
        default: "kernel_stable"
        type: choice
          - kernel_stable
          - kernel_flippy
          - kernel_dev
          - kernel_beta

env:
  TZ: Asia/Shanghai
  ROOTFS_URL: "https://downloads.immortalwrt.org/releases/24.10.2/targets/armsr/armv8/immortalwrt-24.10.2-armsr-armv8-rootfs.tar.gz"
  TARGET_ARCH: "aarch64_generic"
  PACKAGE_REPO_BASE: "https://downloads.immortalwrt.org/releases/24.10.2/packages/aarch64_generic"
  AMLOGIC_IPK_URL: "https://github.com/ophub/luci-app-amlogic/releases/download/3.1.266/luci-app-amlogic_3.1.266_all.ipk"
  AMLOGIC_I18N_IPK_URL: "https://github.com/ophub/luci-app-amlogic/releases/download/3.1.266/luci-i18n-amlogic-zh-cn_3.1.266_all.ipk"

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: 检查代码仓库
        uses: actions/checkout@v4

      - name: 初始化构建环境
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            curl wget tar gzip xz-utils unzip build-essential \
            qemu-user-static binfmt-support pv lvm2 xfsprogs \
            net-tools iputils-ping jq
          
          sudo update-binfmts --enable qemu-aarch64
          sudo systemctl daemon-reload
          
          if ! which qemu-aarch64-static; then
            echo "错误：未找到qemu-aarch64-static"
            exit 1
          fi
          
          sudo timedatectl set-timezone "${TZ}"

      - name: 创建并挂载虚拟磁盘
        run: |
          mnt_size=$(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[^0-9]//g')
          root_size=$(df -h / | tail -1 | awk '{print $4}' | sed 's/[^0-9]//g')
          mnt_size=$(( mnt_size > 0 ? mnt_size - 1 : 10 ))
          root_size=$(( root_size > 0 ? root_size - 4 : 20 ))
          
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          sudo truncate -s "${root_size}"G /root.img
          
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          
          sudo pvcreate /dev/loop6 /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          
          sudo mkfs.xfs -f -i size=512 /dev/github/runner
          
          sudo mkdir -p /builder
          sudo mount -o defaults /dev/github/runner /builder
          sudo chmod 777 /builder
          # 记录工作目录路径
          echo "BUILDER_PATH=/builder" >> $GITHUB_ENV

      - name: 下载并验证rootfs
        id: download_rootfs
        working-directory: /builder
        run: |
          mkdir -p openwrt/rootfs
          
          echo "开始下载rootfs: ${ROOTFS_URL}"
          if ! sudo wget -c "${ROOTFS_URL}" -O openwrt/rootfs.tar.gz; then
            echo "错误：rootfs下载失败"
            exit 1
          fi
          
          if [ ! -f "openwrt/rootfs.tar.gz" ]; then
            echo "错误：rootfs文件不存在"
            exit 1
          fi
          
          echo "解压rootfs..."
          sudo tar -zxf openwrt/rootfs.tar.gz -C openwrt/rootfs
          
          rootfs_contents=$(ls openwrt/rootfs)
          if [ $(echo "$rootfs_contents" | wc -l) -eq 1 ] && [ -d "openwrt/rootfs/$rootfs_contents" ]; then
            sudo mv openwrt/rootfs/$rootfs_contents/* openwrt/rootfs/
            sudo rmdir openwrt/rootfs/$rootfs_contents
          fi
          
          sudo mkdir -p openwrt/rootfs/var/lock
          sudo chmod -R 777 openwrt/rootfs/var
          
          if [ -L "openwrt/rootfs/etc/resolv.conf" ]; then
            sudo rm -f openwrt/rootfs/etc/resolv.conf
          fi
          sudo cp /etc/resolv.conf openwrt/rootfs/etc/resolv.conf
          sudo chmod 777 openwrt/rootfs/etc/resolv.conf
          
          OPKG_PATH=$(sudo find openwrt/rootfs -name "opkg" | grep -E "/usr/bin/opkg|/bin/opkg" | head -n 1)
          if [ -z "$OPKG_PATH" ]; then
            echo "错误：未找到opkg工具"
            exit 1
          fi
          sudo chmod +x "$OPKG_PATH"
          
          # 保存rootfs路径到环境变量
          echo "ROOTFS_FULL_PATH=$(realpath openwrt/rootfs)" >> $GITHUB_ENV
          echo "opkg_path=$OPKG_PATH" >> ${GITHUB_OUTPUT}
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: 下载指定内核文件
        id: download_kernel
        working-directory: /builder
        run: |
          mkdir -p openwrt/kernel
          KERNEL_VERSION="${{ inputs.specific_kernel }}"
          KERNEL_REPO="${{ inputs.kernel_repo }}"
          KERNEL_TAG="${{ inputs.kernel_tag }}"
          KERNEL_URL="https://github.com/${KERNEL_REPO}/releases/download/${KERNEL_TAG}/${KERNEL_VERSION}.tar.gz"
          
          echo "使用指定内核链接: ${KERNEL_URL}"
          
          if ! sudo wget -c "${KERNEL_URL}" -O "openwrt/kernel/${KERNEL_VERSION}.tar.gz"; then
            echo "错误：内核 ${KERNEL_VERSION} 下载失败"
            echo "请检查链接是否正确: ${KERNEL_URL}"
            exit 1
          fi
          
          if [ ! -f "openwrt/kernel/${KERNEL_VERSION}.tar.gz" ]; then
            echo "错误：内核文件 ${KERNEL_VERSION}.tar.gz 不存在"
            exit 1
          fi
          
          sudo mkdir -p "openwrt/kernel/${KERNEL_VERSION}"
          sudo tar -zxf "openwrt/kernel/${KERNEL_VERSION}.tar.gz" -C "openwrt/kernel/${KERNEL_VERSION}"
          
          echo "status=success" >> ${GITHUB_OUTPUT}
          echo "kernel_tags=${KERNEL_VERSION}" >> ${GITHUB_OUTPUT}

      - name: 配置opkg源
        if: ${{ steps.download_rootfs.outputs.status == 'success' && steps.download_kernel.outputs.status == 'success' }}
        run: |
          OPKG_CONF="${{ env.ROOTFS_FULL_PATH }}/etc/opkg/distfeeds.conf"
          sudo mkdir -p $(dirname $OPKG_CONF)
          
          sudo tee $OPKG_CONF << EOF
          src/gz immortalwrt_core https://downloads.immortalwrt.org/releases/24.10.2/targets/armsr/armv8/packages
          src/gz immortalwrt_base ${PACKAGE_REPO_BASE}/base
          src/gz immortalwrt_luci ${PACKAGE_REPO_BASE}/luci
          src/gz immortalwrt_packages ${PACKAGE_REPO_BASE}/packages
          src/gz immortalwrt_routing ${PACKAGE_REPO_BASE}/routing
          src/gz immortalwrt_telephony ${PACKAGE_REPO_BASE}/telephony
          src/gz openwrt_kernel https://downloads.openwrt.org/releases/23.05.0/targets/armsr/armv8/packages
          EOF

      - name: 安装晶晨宝盒（使用指定IPK文件）
        if: ${{ steps.download_rootfs.outputs.status == 'success' && steps.download_kernel.outputs.status == 'success' }}
        run: |
          ROOTFS_DIR="${{ env.ROOTFS_FULL_PATH }}"
          
          # 挂载必要的系统目录
          sudo mount -o bind /dev $ROOTFS_DIR/dev
          sudo mount -o bind /dev/pts $ROOTFS_DIR/dev/pts
          sudo mount -o bind /proc $ROOTFS_DIR/proc
          sudo mount -o bind /sys $ROOTFS_DIR/sys
          sudo mount -o bind /etc/resolv.conf $ROOTFS_DIR/etc/resolv.conf
          
          # 复制qemu模拟器
          sudo cp /usr/bin/qemu-aarch64-static $ROOTFS_DIR/usr/bin/
          sudo chmod +x $ROOTFS_DIR/usr/bin/qemu-aarch64-static
          
          # 配置DNS
          sudo chroot $ROOTFS_DIR /bin/sh -c "echo 'nameserver 8.8.8.8' > /etc/resolv.conf"
          sudo chroot $ROOTFS_DIR /bin/sh -c "echo 'nameserver 114.114.114.114' >> /etc/resolv.conf"
          
          # 创建临时目录存放IPK文件
          sudo mkdir -p $ROOTFS_DIR/tmp/amlogic
          sudo chmod 777 $ROOTFS_DIR/tmp/amlogic
          
          # 下载指定的晶晨宝盒IPK文件
          echo "下载晶晨宝盒主程序: ${AMLOGIC_IPK_URL}"
          if ! sudo wget -c "${AMLOGIC_IPK_URL}" -O "$ROOTFS_DIR/tmp/amlogic/luci-app-amlogic.ipk"; then
            echo "错误：晶晨宝盒主程序下载失败"
            exit 1
          fi
          
          echo "下载晶晨宝盒中文语言包: ${AMLOGIC_I18N_IPK_URL}"
          if ! sudo wget -c "${AMLOGIC_I18N_IPK_URL}" -O "$ROOTFS_DIR/tmp/amlogic/luci-i18n-amlogic-zh-cn.ipk"; then
            echo "错误：晶晨宝盒中文语言包下载失败"
            exit 1
          fi
          
          # 更新包列表
          echo "更新opkg包列表..."
          retry=3
          while [ $retry -gt 0 ]; do
            if sudo chroot $ROOTFS_DIR /bin/sh -c "opkg update --no-check-certificate"; then
              break
            fi
            retry=$((retry - 1))
            echo "opkg update失败，剩余重试次数：$retry"
            sleep 5
          done
          if [ $retry -eq 0 ]; then
            echo "错误：opkg update最终失败"
            exit 1
          fi
          
          # 安装必要依赖
          echo "安装依赖包..."
          if ! sudo chroot $ROOTFS_DIR /bin/sh -c "opkg install --no-check-certificate \
            luci-compat \
            parted \
            lsblk \
            e2fsprogs \
            fdisk \
            attr \
            tar \
            gzip"; then
            echo "警告：部分依赖包安装失败，继续执行后续步骤"
          fi
          
          # 尝试安装替代内核模块
          echo "尝试安装替代显示模块..."
          sudo chroot $ROOTFS_DIR /bin/sh -c "opkg install --no-check-certificate kmod-fbdev || true"
          sudo chroot $ROOTFS_DIR /bin/sh -c "opkg install --no-check-certificate kmod-drm-amlogic || true"
          
          # 安装晶晨宝盒主程序
          echo "安装晶晨宝盒主程序..."
          if ! sudo chroot $ROOTFS_DIR /bin/sh -c "opkg install --no-check-certificate --force-depends /tmp/amlogic/luci-app-amlogic.ipk"; then
            echo "错误：晶晨宝盒主程序安装失败"
            exit 1
          fi
          
          # 安装中文语言包
          echo "安装晶晨宝盒中文语言包..."
          if ! sudo chroot $ROOTFS_DIR /bin/sh -c "opkg install --no-check-certificate /tmp/amlogic/luci-i18n-amlogic-zh-cn.ipk"; then
            echo "错误：晶晨宝盒中文语言包安装失败"
            exit 1
          fi
          
          # 清理临时文件
          sudo chroot $ROOTFS_DIR /bin/sh -c "rm -rf /tmp/amlogic"
          
          # 卸载挂载点
          sudo umount $ROOTFS_DIR/etc/resolv.conf
          sudo umount $ROOTFS_DIR/dev/pts
          sudo umount $ROOTFS_DIR/dev
          sudo umount $ROOTFS_DIR/proc
          sudo umount $ROOTFS_DIR/sys
          sudo rm -f $ROOTFS_DIR/usr/bin/qemu-aarch64-static

      - name: 打包OpenWrt镜像
        if: ${{ steps.download_rootfs.outputs.status == 'success' && steps.download_kernel.outputs.status == 'success' }}
        uses: ophub/amlogic-s9xxx-openwrt@main
        with:
          mode: ophub
          openwrt_path: ${{ env.ROOTFS_FULL_PATH }}  # 使用正确的rootfs路径
          openwrt_board: ${{ inputs.openwrt_board }}
          kernel_repo: ${{ inputs.kernel_repo }}
          kernel_usage: stable
          openwrt_kernel: ${{ steps.download_kernel.outputs.kernel_tags }}
          auto_kernel: true
          # 移除不支持的参数：target_arch和debug

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-s905l3a-${{ env.TARGET_ARCH }}-kernel-${{ steps.download_kernel.outputs.kernel_tags }}
          path: ${{ env.PACKAGED_OUTPUTPATH }}/*
          retention-days: 30
    
